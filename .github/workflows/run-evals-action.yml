name: Build and Evaluate

on:
  pull_request:
    branches: [main]
    paths:
      - "**/*.py"
      - ".github/workflows/run-evals-action.yml"

env:
  IMAGE_NAME: quay.io/rh_ee_taagarwa/demo_mlflow_agent_tracing

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.meta.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get short SHA
        id: meta
        run: echo "sha=${{ github.event.pull_request.head.sha }}" | head -c 11 >> $GITHUB_OUTPUT

      - name: Get image name
        id: image-name
        run: echo "image=${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha }}" >> $GITHUB_OUTPUT

      - name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          push: true
          tags: ${{ steps.image-name.outputs.image }}

  run-evals:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Run evals
        run: |
          docker run --rm \
            -e MLFLOW_TRACKING_URI='${{ secrets.MLFLOW_TRACKING_URI }}' \
            -e MLFLOW_EXPERIMENT_NAME='${{ vars.MLFLOW_EXPERIMENT_NAME }}' \
            -e MLFLOW_SYSTEM_PROMPT_URI='${{ vars.MLFLOW_SYSTEM_PROMPT_URI }}' \
            -e MLFLOW_GENAI_EVAL_MAX_WORKERS='${{ vars.MLFLOW_GENAI_EVAL_MAX_WORKERS }}' \
            -e MLFLOW_GENAI_EVAL_MAX_SCORER_WORKERS='${{ vars.MLFLOW_GENAI_EVAL_MAX_SCORER_WORKERS }}' \
            -e OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
            -e OPENAI_BASE_URL='${{ secrets.OPENAI_BASE_URL }}' \
            -e OPENAI_MODEL_NAME='${{ vars.OPENAI_MODEL_NAME }}' \
            -e EMBEDDING_API_KEY='${{ secrets.EMBEDDING_API_KEY }}' \
            -e EMBEDDING_MODEL_NAME='${{ vars.EMBEDDING_MODEL_NAME }}' \
            -e EMBEDDING_BASE_URL='${{ secrets.EMBEDDING_BASE_URL }}' \
            -e EMBEDDING_SEARCH_PREFIX='${{ vars.EMBEDDING_SEARCH_PREFIX }}' \
            ${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.sha }} \
            /bin/sh -c "uv run --locked --no-sync scripts/ingest.py && uv run --locked --no-sync python scripts/inner_loop_evals.py --run-name ${{ needs.build-and-push.outputs.sha }}"
